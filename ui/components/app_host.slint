import { Theme } from "theme.slint";
import { SettingsApp } from "apps/settings.slint";

export component AppHost inherits Rectangle {
    in-out property <bool> open: false;
    in-out property <string> app_id: "";
    in property <bool> reduce_motion: false;

    background: #00000000;
    visible: open || panel.opacity > 0.0;

    property <bool> dragging: false;
    property <length> drag_offset: 0px;

    function close() {
        root.open = false;
        root.app_id = "";
        root.dragging = false;
        root.drag_offset = 0px;
    }

    // No scrim, but the overlay must still block clicks reaching the desktop.

    panel := Rectangle {
        x: 0px;
        y: root.open ? (root.dragging ? root.drag_offset : 0px) : parent.height;
        width: parent.width;
        height: parent.height;
        background: Theme.surface_bg;
        border-width: 0px;
        border-color: Theme.border;
        border-radius: 0px;
        clip: true;
        opacity: root.open ? 1.0 : 0.0;

        animate y { duration: (root.reduce_motion || root.dragging) ? 0ms : Theme.anim_med; easing: ease-in-out; }
        animate opacity { duration: root.reduce_motion ? 0ms : Theme.anim_med; }

        // Catch-all: consume clicks so they don't go through to Desktop.
        // Placed first so interactive children drawn later stay clickable.
        TouchArea {
            width: parent.width;
            height: parent.height;
            enabled: root.open;
            clicked => {}
            pointer-event(_) => {}
        }

        // Handle area (swipe/drag down to close).
        Rectangle {
            x: 0px;
            y: 0px;
            width: parent.width;
            height: 14px;
            background: #00000000;

            Rectangle {
                x: (parent.width - 44px) / 2;
                y: 6px;
                width: 44px;
                height: 4px;
                border-radius: 2px;
                background: Theme.border;
                opacity: 0.75;
            }
        }

        SwipeGestureHandler {
            x: 0px;
            y: 0px;
            width: parent.width;
            height: 56px;
            enabled: root.open;
            handle-swipe-down: true;

            moved => {
                if (self.swiping) {
                    root.dragging = true;
                    root.drag_offset = min(max(self.current-position.y - self.pressed-position.y, 0px), parent.height);
                }
            }

            swiped => {
                root.dragging = false;
                let delta = self.current-position.y - self.pressed-position.y;
                if (delta > 60px) {
                    root.close();
                } else {
                    root.drag_offset = 0px;
                }
            }
        }

        property <string> title:
            root.app_id == "settings" ? "Настройки"
          : root.app_id == "terminal" ? "Терминал"
          : root.app_id == "apps" ? "Приложения"
          : "Приложение";

        Text {
            x: Theme.gutter;
            y: 16px;
            text: panel.title;
            color: Theme.text;
            font-size: Theme.font_xl;
            font-weight: 800;
        }

        Rectangle {
            x: parent.width - Theme.gutter - 28px;
            y: 12px;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #00000000;

            Text {
                width: parent.width;
                height: parent.height;
                text: "×";
                color: Theme.text_dim;
                font-size: 18px;
                font-weight: 700;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            TouchArea {
                width: parent.width;
                height: parent.height;
                clicked => { root.close(); }
            }
        }

        Rectangle {
            x: 0px;
            y: 44px;
            width: parent.width;
            height: 1px;
            background: Theme.border;
        }

        content := Rectangle {
            x: 0px;
            y: 45px;
            width: parent.width;
            height: parent.height - 45px;
            background: #00000000;
            clip: true;

            SettingsApp {
                width: parent.width;
                height: parent.height;
                visible: root.app_id == "settings";
                reduce_motion: root.reduce_motion;
            }

            Text {
                visible: root.app_id != "" && root.app_id != "settings";
                width: parent.width;
                height: parent.height;
                text: "Пока не реализовано";
                color: Theme.text_muted;
                font-size: Theme.font_md;
                font-weight: 600;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }

}
