import { Theme } from "../theme.slint";

component IosSectionTitle inherits Text {
    in property <string> title: "";
    text: root.title;
    color: Theme.text_muted;
    font-size: Theme.font_xs;
    font-weight: 700;
}

component IosCard inherits Rectangle {
    background: Theme.surface_bg;
    border-width: 1px;
    border-color: Theme.border;
    border-radius: Theme.radius_md;
    clip: true;
}

component IosSwitch inherits Rectangle {
    in-out property <bool> value: false;
    in property <bool> reduce_motion: false;

    width: 50px;
    height: 28px;
    border-radius: self.height / 2;
    background: root.value ? Theme.accent : Theme.border;
    animate background { duration: root.reduce_motion ? 0ms : Theme.anim_fast; }

    thumb := Rectangle {
        width: 22px;
        height: 22px;
        border-radius: self.height / 2;
        background: Theme.surface_bg;
        y: 3px;
        x: root.value ? parent.width - self.width - 3px : 3px;
        animate x { duration: root.reduce_motion ? 0ms : Theme.anim_fast; easing: ease-out; }
    }

    TouchArea {
        width: parent.width;
        height: parent.height;
        clicked => { root.value = !root.value; }
    }
}

component IosRowBase inherits Rectangle {
    in property <string> title: "";
    in property <string> value_text: "";
    in property <bool> show_value: false;
    in property <bool> show_chevron: true;
    in property <bool> show_divider: true;
    in property <bool> reduce_motion: false;
    in property <bool> show_icon: false;
    in property <image> icon;

    height: 44px;
    background: #00000000;

    property <length> left_inset: show_icon ? 44px : 12px;
    property <length> right_inset: show_chevron ? 24px : 12px;
    property <length> trailing_gap: 8px;

    if (root.show_icon) : Rectangle {
        x: 12px;
        y: 0px;
        width: 26px;
        height: parent.height;
        background: #00000000;
        Image {
            x: (parent.width - 18px) / 2;
            y: (parent.height - 18px) / 2;
            width: 18px;
            height: 18px;
            source: root.icon;
            image-fit: contain;
        }
    }

    title_clip := Rectangle {
        x: root.left_inset;
        y: 0px;
        width: parent.width - root.left_inset - (root.show_value ? 110px : root.right_inset) - root.trailing_gap;
        height: parent.height;
        background: #00000000;
        clip: true;

        Text {
            width: parent.width;
            height: parent.height;
            text: root.title;
            color: Theme.text;
            font-size: Theme.font_sm;
            font-weight: 600;
            vertical-alignment: center;
            wrap: no-wrap;
        }
    }

    if (root.show_value) : Text {
        x: 0px;
        width: parent.width - root.right_inset;
        height: parent.height;
        text: root.value_text;
        color: Theme.text_dim;
        font-size: Theme.font_sm;
        font-weight: 600;
        horizontal-alignment: right;
        vertical-alignment: center;
    }

    if (root.show_chevron) : Text {
        x: parent.width - 16px;
        y: 0px;
        width: 12px;
        height: parent.height;
        text: "›";
        color: Theme.text_muted;
        font-size: 18px;
        font-weight: 700;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    if (root.show_divider) : Rectangle {
        x: root.left_inset;
        y: parent.height - 1px;
        width: parent.width - root.left_inset;
        height: 1px;
        background: Theme.border;
        opacity: 0.85;
    }
}

component IosSwitchRow inherits Rectangle {
    in property <string> title: "";
    in-out property <bool> value: false;
    in property <bool> show_divider: true;
    in property <bool> reduce_motion: false;

    height: 44px;
    background: #00000000;

    title_clip := Rectangle {
        x: 12px;
        y: 0px;
        width: parent.width - 12px - 62px - 8px;
        height: parent.height;
        background: #00000000;
        clip: true;

        Text {
            width: parent.width;
            height: parent.height;
            text: root.title;
            color: Theme.text;
            font-size: Theme.font_sm;
            font-weight: 600;
            vertical-alignment: center;
            wrap: no-wrap;
        }
    }

    IosSwitch {
        x: parent.width - self.width - 12px;
        y: (parent.height - self.height) / 2;
        value <=> root.value;
        reduce_motion: root.reduce_motion;
    }

    if (root.show_divider) : Rectangle {
        x: 12px;
        y: parent.height - 1px;
        width: parent.width - 12px;
        height: 1px;
        background: Theme.border;
        opacity: 0.85;
    }
}

component SettingsNavItem inherits Rectangle {
    in property <string> text: "";
    in property <bool> selected: false;
    in property <bool> reduce_motion: false;
    callback clicked();

    height: 34px;
    background: selected ? Theme.focus_ring : #00000000;
    border-radius: 10px;

    Text {
        x: 10px;
        width: parent.width - 20px;
        height: parent.height;
        text: root.text;
        color: root.selected ? Theme.text : Theme.text_dim;
        font-size: Theme.font_sm;
        font-weight: root.selected ? 700 : 600;
        vertical-alignment: center;
    }

    TouchArea {
        width: parent.width;
        height: parent.height;
        clicked => { root.clicked(); }
    }

    animate background { duration: root.reduce_motion ? 0ms : Theme.anim_fast; }
}

component SettingsToggleRow inherits Rectangle {
    in property <string> label: "";
    in-out property <bool> value: false;
    in property <bool> reduce_motion: false;

    height: 38px;
    background: #00000000;

    Text {
        x: 0px;
        width: parent.width - 72px;
        height: parent.height;
        text: root.label;
        color: Theme.text;
        font-size: Theme.font_sm;
        font-weight: 600;
        vertical-alignment: center;
    }

    track := Rectangle {
        x: parent.width - 58px;
        y: (parent.height - 22px) / 2;
        width: 58px;
        height: 22px;
        border-radius: 11px;
        background: root.value ? Theme.accent : Theme.border;
        animate background { duration: root.reduce_motion ? 0ms : Theme.anim_fast; }

        thumb := Rectangle {
            y: 3px;
            width: 16px;
            height: 16px;
            border-radius: 8px;
            background: Theme.surface_bg;
            x: root.value ? parent.width - self.width - 3px : 3px;
            animate x { duration: root.reduce_motion ? 0ms : Theme.anim_fast; easing: ease-out; }
        }
    }

    TouchArea {
        width: parent.width;
        height: parent.height;
        clicked => { root.value = !root.value; }
    }
}

component SettingsSliderRow inherits Rectangle {
    in property <string> label: "";
    in property <float> minimum: 0;
    in property <float> maximum: 100;
    in property <float> step: 1;
    in-out property <float> value: 50;
    in property <bool> reduce_motion: false;

    height: 44px;
    background: #00000000;

    Text {
        x: 0px;
        y: 0px;
        width: parent.width;
        height: 18px;
        text: root.label;
        color: Theme.text;
        font-size: Theme.font_sm;
        font-weight: 600;
    }

    track := Rectangle {
        x: 0px;
        y: parent.height - 12px;
        width: parent.width;
        height: 4px;
        border-radius: 2px;
        background: Theme.border;

        fill := Rectangle {
            x: 0px;
            y: 0px;
            width: parent.width * (root.value - root.minimum) / max(root.maximum - root.minimum, 1);
            height: parent.height;
            border-radius: parent.border-radius;
            background: Theme.accent;
            animate width { duration: root.reduce_motion ? 0ms : Theme.anim_fast; easing: ease-out; }
        }
    }

    thumb := Rectangle {
        width: 14px;
        height: 14px;
        border-radius: 7px;
        background: Theme.accent;
        y: track.y - (self.height - track.height) / 2;
        x: clamp(track.width * (root.value - root.minimum) / max(root.maximum - root.minimum, 1) - self.width / 2, 0px, track.width - self.width);
        animate x { duration: root.reduce_motion ? 0ms : Theme.anim_fast; easing: ease-out; }
    }

    function set-value(v: float) {
        let snapped = root.step > 0 ? (round((v - root.minimum) / root.step) * root.step + root.minimum) : v;
        root.value = max(root.minimum, min(root.maximum, snapped));
    }

    touch := TouchArea {
        width: parent.width;
        height: parent.height;
        pointer-event(event) => {
            if (event.button != PointerEventButton.left) { return; }
            if (event.kind == PointerEventKind.up) { return; }
            root.set-value(root.minimum + touch.mouse-x * (root.maximum - root.minimum) / max(track.width, 1px));
        }
        moved => {
            root.set-value(root.minimum + touch.mouse-x * (root.maximum - root.minimum) / max(track.width, 1px));
        }
    }
}

component SettingsNavScroll inherits Rectangle {
    in property <bool> reduce_motion: false;
    in-out property <int> selected_index: 0;
    // Total number of items; used to compute viewport height.
    in property <int> item_count: 0;

    property <length> item_h: 36px;
    property <length> content_h: item_count * item_h;

    background: #00000000;
    clip: true;

    Flickable {
        width: parent.width;
        height: parent.height;
        interactive: true;

        viewport-height: content_h;
        viewport-width: parent.width;

        content := Rectangle {
            width: parent.width;
            height: content_h;
            background: #00000000;

            // Items are placed by y = index * item_h.
            SettingsNavItem { y: 0 * item_h; width: parent.width; text: "Система"; selected: root.selected_index == 0; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 0; } }
            SettingsNavItem { y: 1 * item_h; width: parent.width; text: "Экран"; selected: root.selected_index == 1; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 1; } }
            SettingsNavItem { y: 2 * item_h; width: parent.width; text: "Звук"; selected: root.selected_index == 2; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 2; } }
            SettingsNavItem { y: 3 * item_h; width: parent.width; text: "Сеть"; selected: root.selected_index == 3; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 3; } }
            SettingsNavItem { y: 4 * item_h; width: parent.width; text: "О системе"; selected: root.selected_index == 4; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 4; } }

            SettingsNavItem { y: 5 * item_h; width: parent.width; text: "Аккаунты"; selected: root.selected_index == 5; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 5; } }
            SettingsNavItem { y: 6 * item_h; width: parent.width; text: "Приватность"; selected: root.selected_index == 6; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 6; } }
            SettingsNavItem { y: 7 * item_h; width: parent.width; text: "Уведомления"; selected: root.selected_index == 7; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 7; } }
            SettingsNavItem { y: 8 * item_h; width: parent.width; text: "Хранилище"; selected: root.selected_index == 8; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 8; } }
            SettingsNavItem { y: 9 * item_h; width: parent.width; text: "Питание"; selected: root.selected_index == 9; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 9; } }
            SettingsNavItem { y: 10 * item_h; width: parent.width; text: "Язык"; selected: root.selected_index == 10; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 10; } }
            SettingsNavItem { y: 11 * item_h; width: parent.width; text: "Дата и время"; selected: root.selected_index == 11; reduce_motion: root.reduce_motion; clicked => { root.selected_index = 11; } }
        }
    }
}

export component SettingsApp inherits Rectangle {
    in property <bool> reduce_motion: false;
    in-out property <int> selected_index: 0;

    // demo state (later wire to Rust)
    in-out property <bool> setting_dark_mode: false;
    in-out property <bool> setting_reduce_motion: false;
    in-out property <bool> setting_wifi: true;
    in-out property <bool> setting_bluetooth: false;
    in-out property <float> setting_brightness: 60;
    in-out property <float> setting_volume: 70;

    background: #00000000;

    // Left navigation + right content.
    nav := Rectangle {
        x: 0px;
        y: 0px;
        width: 116px;
        height: parent.height;
        background: Theme.surface_bg_2;
        border-width: 0px;
        clip: true;

        Rectangle {
            x: parent.width - 1px;
            y: 0px;
            width: 1px;
            height: parent.height;
            background: Theme.border;
        }

        Text {
            x: 10px;
            y: 10px;
            text: "Меню";
            color: Theme.text_muted;
            font-size: Theme.font_sm;
            font-weight: 700;
        }

        menu := Rectangle {
            x: 8px;
            y: 32px;
            width: parent.width - 16px;
            height: parent.height - 40px;
            background: #00000000;

            SettingsNavScroll {
                width: parent.width;
                height: parent.height;
                reduce_motion: root.reduce_motion;
                selected_index <=> root.selected_index;
                item_count: 12;
            }
        }
    }

    detail := Rectangle {
        x: nav.width;
        y: 0px;
        width: parent.width - nav.width;
        height: parent.height;
        background: #00000000;

        // Right pane is scrollable (iOS-like long lists).
        detail_scroll := Flickable {
            width: parent.width;
            height: parent.height;
            interactive: true;

            viewport-width: parent.width;
            viewport-height: detail_content.height;

            detail_content := Rectangle {
                width: parent.width;
                height:
                    root.selected_index == 0 ? 304px
                  : root.selected_index == 1 ? 170px
                  : root.selected_index == 2 ? 170px
                  : root.selected_index == 3 ? 190px
                  : root.selected_index == 4 ? 120px
                  : 120px;
                background: #00000000;

                // "Система" (start at top, no extra heading; AppHost already has a header).
                if root.selected_index == 0 : Rectangle {
                    x: Theme.gutter;
                    y: 8px;
                    width: parent.width - Theme.gutter * 2;
                    height: parent.height;
                    background: #00000000;

                    IosSectionTitle { x: 0px; y: 0px; title: "ОБЩЕЕ"; }
                    IosCard {
                        x: 0px;
                        y: 14px;
                        width: parent.width;
                        height: 88px;

                        IosSwitchRow { y: 0px; width: parent.width; title: "Тёмная тема"; value <=> root.setting_dark_mode; reduce_motion: root.reduce_motion; show_divider: true; }
                        IosSwitchRow { y: 44px; width: parent.width; title: "Уменьшить анимации"; value <=> root.setting_reduce_motion; reduce_motion: root.reduce_motion; show_divider: false; }
                    }

                    IosSectionTitle { x: 0px; y: 122px; title: "ЯЗЫК И РЕГИОН"; }
                    IosCard {
                        x: 0px;
                        y: 136px;
                        width: parent.width;
                        height: 88px;

                        IosRowBase { y: 0px; width: parent.width; title: "Язык"; show_value: true; value_text: "Русский"; show_divider: true; }
                        IosRowBase { y: 44px; width: parent.width; title: "Дата и время"; show_value: true; value_text: "Авто"; show_divider: false; }
                    }

                    IosSectionTitle { x: 0px; y: 236px; title: "ИНФОРМАЦИЯ"; }
                    IosCard {
                        x: 0px;
                        y: 250px;
                        width: parent.width;
                        height: 44px;

                        IosRowBase { y: 0px; width: parent.width; title: "О системе"; show_value: false; show_divider: false; }
                    }
                }

                // Other sections: placeholders (for now).
                if root.selected_index != 0 : Rectangle {
                    x: Theme.gutter;
                    y: 0px;
                    width: parent.width - Theme.gutter * 2;
                    height: parent.height;
                    background: #00000000;

                    Text {
                        text: "Раздел пока не реализован";
                        color: Theme.text_muted;
                        font-size: Theme.font_md;
                        font-weight: 600;
                    }
                }
            }
        }
    }
}
